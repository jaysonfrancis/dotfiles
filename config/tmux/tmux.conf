#### General Settings ####
set -g default-command /bin/zsh
# set -g default-terminal "screen-256color"
set-option -g focus-events on  # Required for auto-reload in editors

set -g default-terminal 'xterm-ghostty'
set -gas terminal-overrides ',xterm-ghostty:Ms=\E]52;%p1%s;%p2%s\007'
set -g set-clipboard on

#### Detect if inside SSH (remote) ####
if-shell '[ -n "$SSH_CONNECTION" ]' \
  'set -g @host_type remote' \
  'set -g @host_type local'

#### Allow tab title changes
set -g allow-rename off
set -g automatic-rename on
set -g automatic-rename-format '#{b:pane_current_path}'

#### Type ":sync" to synchronize panes (toggle)
set -as command-alias "sync=set -w synchronize-panes\; display 'synchronize-panes: #{?pane_synchronized,on,off}'"

#### Terminal & Colors
set-option -sa terminal-overrides ",xterm*:Tc"  # TrueColor Support
set-option -a terminal-features 'xterm-256color:RGB'
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # Undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # Undercurl colors

#### Reorder tabs TODO: change keys
bind-key -n S-Left swap-window -t -1\; select-window -t -1
bind-key -n S-Right swap-window -t +1\; select-window -t +1

#### Status Bar TODO: update ####
set-option -g status on
set-option -g status-interval 5  # Refresh rate (lower for better performance)
set-option -g status-justify left
set-option -g status-left "[#S] "  # Show only session name
set-option -g status-right "#(whoami)@#H | %Y-%m-%d %H:%M"  # Show username, hostname, and time

#### Window & Pane Indexing ####
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1
set-option -g renumber-windows on  # Auto-renumber windows when closing one

#### Window & Pane Behavior ####
set-window-option -g monitor-activity off  # Enable activity alerts
set-option -g visual-activity off

#### Scrolling & History ####
set -g history-limit 50000  # Increase scrollback buffer
set -s escape-time 0  # Improve Vim mode switching delay
set -g mouse on  # Enable mouse support
set -g terminal-overrides ',*:smcup@:rmcup@'  # Fix mouse scroll issues in some terminals

#### Theme and window formats (local/remote theme) ####
if-shell '[ "#{@host_type}" = "local" ]' \
  'set -g status-position bottom; \
   set -g status-style "bg=black,fg=white"; \
   set -g @win_fmt_hidden_local        "#[fg=white,bg=black] #I "; \
   set -g @win_fmt_current_hidden_local "#[fg=black,bg=colour34,bold] #I "; \
   set -g @win_fmt_shown_local         "#[fg=white,bg=black] #I #[fg=white,bg=black]#W "; \
   set -g @win_fmt_current_shown_local  "#[fg=black,bg=colour34,bold] #I #[fg=black,bg=colour34]#W "; \
   set-window-option -g window-status-format "#{?#{==:#{window_name},shk},#[fg=black,bg=colour117] #I #[fg=black,bg=colour117]#W ,#[fg=white,bg=black] #I #[fg=white,bg=black]#W }"; \
   set-window-option -g window-status-current-format "#{?#{==:#{window_name},shk},#[fg=black,bg=colour117,bold] #I #[fg=black,bg=colour117]#W ,#[fg=black,bg=colour34,bold] #I #[fg=black,bg=colour34]#W }"' \
  'set -g status-position top; \
   set -g status-style "bg=colour235,fg=white"; \
   set -g @win_fmt_hidden_remote        "#[fg=white,bg=colour235] #I "; \
   set -g @win_fmt_current_hidden_remote "#[fg=black,bg=colour117,bold] #I "; \
   set -g @win_fmt_shown_remote         "#[fg=white,bg=colour235] #I #[fg=white,bg=colour235]#W "; \
   set -g @win_fmt_current_shown_remote  "#[fg=black,bg=colour117,bold] #I #[fg=black,bg=colour117]#W "; \
   set-window-option -g window-status-format "#[fg=white,bg=colour235] #I #[fg=white,bg=colour235]#W "; \
   set-window-option -g window-status-current-format "#[fg=black,bg=colour117,bold] #I #[fg=black,bg=colour117]#W "'

#### Toggle Window Name Visibility (local/remote theme) ####
bind-key n if-shell '[ "$(tmux show -gv @win_names)" = "1" ]' \
  "set -g @win_names 0; \
   if-shell '[ \"#{@host_type}\" = \"local\" ]' \
      'set-window-option -g window-status-format \"#[fg=white,bg=black] #I \"; \
       set-window-option -g window-status-current-format \"#[fg=black,bg=colour34,bold] #I \"' \
      'set-window-option -g window-status-format \"#[fg=white,bg=colour235] #I \"; \
       set-window-option -g window-status-current-format \"#[fg=black,bg=colour117,bold] #I \"'" \
  "set -g @win_names 1; \
   if-shell '[ \"#{@host_type}\" = \"local\" ]' \
      'set-window-option -g window-status-format \"#[fg=white,bg=black] #I #[fg=white,bg=black]#W \"; \
       set-window-option -g window-status-current-format \"#[fg=black,bg=colour34,bold] #I #[fg=black,bg=colour34]#W \"' \
      'set-window-option -g window-status-format \"#[fg=white,bg=colour235] #I #[fg=white,bg=colour235]#W \"; \
       set-window-option -g window-status-current-format \"#[fg=black,bg=colour117,bold] #I #[fg=black,bg=colour117]#W \"'"

#### Rename Window Quickly ####
bind-key r command-prompt -I "#W" "rename-window '%%'"

#### Smart Pane Switching - Vim Aware ####
# Smart pane switching with awareness of Vim splits
# Use Ctrl+hjkl to navigate seamlessly between tmux panes and vim splits
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R'

# Fallback for when you need the literal Ctrl+l (clear screen) in non-vim contexts
bind-key C-l send-keys 'C-l'

#### Key Bindings - Different for Local vs Remote ####
unbind C-b  # Unbind default prefix

# if-shell '[ "#{@host_type}" = "local" ]' \
#   'set -g prefix `; \
#    bind ` send-prefix' \
#   'set -g prefix C-`; \
#    bind C-` send-prefix'
set -g prefix `  # Change prefix to backtick (`) for easier access
bind ` send-prefix # Press twice for remote prefix

#### F12 Toggle for Nested Sessions ####
# Default mode: local
set -g @nested_mode 'local'

# F12 toggles nested mode
bind -n F12 if-shell \
  '[ "#{@nested_mode}" = "local" ]' \
  'set -g @nested_mode remote; set prefix None; set key-table off; display-message "Nested mode: REMOTE — prefix passthrough enabled"' \
  'set -g @nested_mode local; set -u prefix; set -u key-table; display-message "Nested mode: LOCAL — prefix active"'

# Allow F12 to work even in "off" key table
bind -T off F12 if-shell \
  '[ "#{@nested_mode}" = "remote" ]' \
  'set -g @nested_mode local; set -u prefix; set -u key-table; display-message "Nested mode: LOCAL — prefix active"'

#### Pane Border Colors ####
set -g pane-border-style "fg=#073642"
set -g pane-active-border-style "fg=#eee8d5"

#### Status Right - Enhanced for Local/Remote Identification ####
if-shell '[ "#{@host_type}" = "local" ]' \
  'set -g status-right "#{?window_zoomed_flag,#[fg=green][Z]#[default],}#{?#{==:#{@nested_mode},local},#[fg=green]●#[default],#[fg=blue]●#[default]} \
#[fg=white,bg=black]\
#[fg=black,bg=white]\
#[fg=black,bg=colour34,bold] #h "' \
  'set -g status-right "#{?window_zoomed_flag,#[fg=green][Z]#[default],}#{?#{==:#{@nested_mode},local},#[fg=green]●#[default],#[fg=blue]●#[default]} \
#[fg=black,bg=white]\
#[fg=black,bg=colour117]\
#[fg=black,bg=colour117,bold] #h "'

#### Plugins ####
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect' #

#### Initialize TMUX Plugin Manager (Keep at the Bottom) ####
run '~/.tmux/plugins/tpm/tpm'
