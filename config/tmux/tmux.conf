#### General Settings ####
set -g default-command /bin/zsh
set-option -g focus-events on
set -g default-terminal 'xterm-ghostty'
set -gas terminal-overrides ',xterm-ghostty:Ms=\E]52;%p1%s;%p2%s\007'
set -g set-clipboard on

#### Detect if inside SSH (remote) ####
if-shell '[ -n "$SSH_CONNECTION" ]' \
  'set -g @host_type remote' \
  'set -g @host_type local'

#### Window & Pane Settings ####
set -g allow-rename off
set -g automatic-rename on
set -g automatic-rename-format '#{b:pane_current_path}'
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1
set-option -g renumber-windows on

#### Performance & Behavior ####
set -g history-limit 50000
set -s escape-time 0
set -g mouse on
set-window-option -g monitor-activity off
set-option -g visual-activity off

#### Terminal Features ####
set-option -sa terminal-overrides ",xterm*:Tc"
set-option -a terminal-features 'xterm-256color:RGB'
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'
set -g terminal-overrides ',*:smcup@:rmcup@'

#### Status Bar Base ####
set-option -g status on
set-option -g status-interval 5
set-option -g status-justify left
set-option -g status-left "[#S] "

#### Theme - Local vs Remote ####
if-shell '[ "#{@host_type}" = "local" ]' \
  'set -g status-position bottom; \
   set -g status-style "bg=black,fg=white"; \
   set-window-option -g window-status-format "#{?#{==:#{window_name},shk},#[fg=black,bg=colour117] #I #[fg=black,bg=colour117]#W ,#[fg=white,bg=black] #I #[fg=white,bg=black]#W }"; \
   set-window-option -g window-status-current-format "#{?#{==:#{window_name},shk},#[fg=black,bg=colour117,bold] #I #[fg=black,bg=colour117]#W ,#[fg=black,bg=colour34,bold] #I #[fg=black,bg=colour34]#W }"' \
  'set -g status-position top; \
   set -g status-style "bg=colour235,fg=white"; \
   set-window-option -g window-status-format "#[fg=white,bg=colour235] #I #[fg=white,bg=colour235]#W "; \
   set-window-option -g window-status-current-format "#[fg=black,bg=colour117,bold] #I #[fg=black,bg=colour117]#W "'

#### Status Right with Nested Indicator ####
if-shell '[ "#{@host_type}" = "local" ]' \
  'set -g status-right "#{?window_zoomed_flag,#[fg=green][Z]#[default],}#{?#{==:#{@nested_mode},local},#[fg=colour240]●#[default],#[fg=colour117]●#[default]} #[fg=black,bg=colour34,bold] #h "' \
  'set -g status-right "#{?window_zoomed_flag,#[fg=green][Z]#[default],}#{?#{==:#{@nested_mode},local},#[fg=colour240]●#[default],#[fg=colour117]●#[default]} #[fg=black,bg=colour117,bold] #h "'

#### Key Bindings ####
unbind C-b
set -g prefix `
bind ` send-prefix

#### Window Management ####
bind c new-window
bind r command-prompt -I "#W" "rename-window '%%'"
bind-key -n S-Left swap-window -t -1\; select-window -t -1
bind-key -n S-Right swap-window -t +1\; select-window -t +1

#### Pane Management ####
bind s split-window -v
bind v split-window -h

#### Smart Vim Navigation ####
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'
bind-key C-l send-keys 'C-l'

#### F12 Nested Mode Toggle ####
set -g @nested_mode 'local'

bind -n F12 if-shell \
  '[ "#{@nested_mode}" = "local" ]' \
  'set -g @nested_mode remote; set prefix None; set key-table off; display-message "REMOTE MODE: All keys pass through"' \
  'set -g @nested_mode local; set -u prefix; set -u key-table; display-message "LOCAL MODE: Prefix active"'

bind -T off F12 \
  'set -g @nested_mode local' \; \
  'set -u prefix' \; \
  'set -u key-table' \; \
  'display-message "LOCAL MODE: Prefix active"'

#### Toggle Window Name Visibility ####
bind-key n if-shell '[ "$(tmux show -gv @win_names)" = "1" ]' \
  "set -g @win_names 0; \
   if-shell '[ \"#{@host_type}\" = \"local\" ]' \
      'set-window-option -g window-status-format \"#[fg=white,bg=black] #I \"; \
       set-window-option -g window-status-current-format \"#[fg=black,bg=colour34,bold] #I \"' \
      'set-window-option -g window-status-format \"#[fg=white,bg=colour235] #I \"; \
       set-window-option -g window-status-current-format \"#[fg=black,bg=colour117,bold] #I \"'" \
  "set -g @win_names 1; \
   if-shell '[ \"#{@host_type}\" = \"local\" ]' \
      'set-window-option -g window-status-format \"#{?#{==:#{window_name},shk},#[fg=black,bg=colour117] #I #[fg=black,bg=colour117]#W ,#[fg=white,bg=black] #I #[fg=white,bg=black]#W }\"; \
       set-window-option -g window-status-current-format \"#{?#{==:#{window_name},shk},#[fg=black,bg=colour117,bold] #I #[fg=black,bg=colour117]#W ,#[fg=black,bg=colour34,bold] #I #[fg=black,bg=colour34]#W }\"' \
      'set-window-option -g window-status-format \"#[fg=white,bg=colour235] #I #[fg=white,bg=colour235]#W \"; \
       set-window-option -g window-status-current-format \"#[fg=black,bg=colour117,bold] #I #[fg=black,bg=colour117]#W \"'"

#### Colors ####
set -g pane-border-style "fg=#073642"
set -g pane-active-border-style "fg=#eee8d5"

#### Utilities ####
set -as command-alias "sync=set -w synchronize-panes\; display 'synchronize-panes: #{?pane_synchronized,on,off}'"

#### Plugins ####
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'

#### Initialize TPM ####
run '~/.tmux/plugins/tpm/tpm'